<script lang="ts">
  import { onMount } from 'svelte';
  import { browser } from '$app/environment';
  
  // Layout components
  import Sidebar from '$lib/components/Sidebar.svelte';
  import TabBar from '$lib/components/TabBar.svelte';
  import StatusBar from '$lib/components/StatusBar.svelte';
  import ActivityBar from '$lib/components/ActivityBar.svelte';
  
  // Content components
  import Terminal from '$lib/components/Terminal.svelte';
  import TauriTerminal from '$lib/components/TauriTerminal.svelte';
  import DashboardEnhanced from '$lib/components/DashboardEnhanced.svelte';
  import NeovimEditor from '$lib/components/NeovimEditor.svelte';
  import TestResultsView from '$lib/components/TestResultsView.svelte';
  import UpdateNotification from '$lib/components/UpdateNotification.svelte';
  import ShareDialog from '$lib/components/ShareDialog.svelte';
  import ConfigPanel from '$lib/components/ConfigPanel.svelte';
  import CommandPalette from '$lib/components/CommandPalette.svelte';
  import GitPanel from '$lib/components/GitPanel.svelte';
  import SymbolOutline from '$lib/components/SymbolOutline.svelte';
  import SettingsModal from '$lib/components/SettingsModal.svelte';
  
  // Stores
  import { activeTab, tabs, createTerminal } from '$lib/stores/orchestrator';
  import { createTauriTerminal, createDashboardTab, openFile } from '$lib/stores/tauri-orchestrator';
  import { settings } from '$lib/stores/settings';
  import { toggleTheme } from '$lib/services/theme';
  
  // Types
  import type { Tab } from '$lib/types';
  
  let isTauri = '__TAURI__' in window;
  let activeView = 'explorer';
  let showShareDialog = false;
  let showSettingsModal = false;
  let showGitPanel = false;
  let showSymbolOutline = false;
  let sessionId = '';
  let layoutMode: 'single' | 'split-horizontal' | 'split-vertical' = 'single';
  let secondaryTab: Tab | null = null;
  
  // Keyboard shortcuts
  let shortcuts = {
    'ctrl+k': () => showCommandPalette = true,
    'ctrl+p': () => showCommandPalette = true,
    'ctrl+shift+p': () => showCommandPalette = true,
    'ctrl+b': () => toggleSidebar(),
    'ctrl+`': () => openTerminal(),
    'ctrl+s': () => saveCurrentFile(),
    'ctrl+w': () => closeCurrentTab(),
    'ctrl+shift+e': () => activeView = 'explorer',
    'ctrl+shift+g': () => showGitPanel = true,
    'ctrl+shift+o': () => showSymbolOutline = true,
    'ctrl+shift+x': () => activeView = 'extensions',
    'ctrl+shift+d': () => activeView = 'debug',
    'ctrl+,': () => showSettingsModal = true,
  };
  
  let showCommandPalette = false;
  let sidebarVisible = true;
  
  onMount(async () => {
    // Register keyboard shortcuts
    document.addEventListener('keydown', handleKeydown);
    
    // Initialize Tauri-specific features
    if (isTauri && browser) {
      const { invoke } = await import('@tauri-apps/api/core');
      const { appWindow } = await import('@tauri-apps/api/window');
      const { listen } = await import('@tauri-apps/api/event');
      
      try {
        // Initialize session
        const session = await invoke('db_create_session', {
          name: 'OrchFlow Session',
          projectPath: await invoke('get_current_dir')
        });
        sessionId = session.id;
        
        // Listen for file drops
        await appWindow.onFileDropEvent((event) => {
          if (event.payload.type === 'drop') {
            event.payload.paths.forEach(path => {
              openFile(path);
            });
          }
        });
        
        // Listen for startup complete
        const unlisten = await listen('startup-complete', (event) => {
          console.log('Startup metrics:', event.payload);
        });
        
        return () => {
          document.removeEventListener('keydown', handleKeydown);
          unlisten();
        };
      } catch (err) {
        console.error('Failed to initialize Tauri features:', err);
      }
    }
    
    return () => {
      document.removeEventListener('keydown', handleKeydown);
    };
  });
  
  function handleKeydown(event: KeyboardEvent) {
    const key = `${event.ctrlKey || event.metaKey ? 'ctrl+' : ''}${event.shiftKey ? 'shift+' : ''}${event.key.toLowerCase()}`;
    
    if (shortcuts[key]) {
      event.preventDefault();
      shortcuts[key]();
    }
  }
  
  function handleViewChange(event: CustomEvent<string>) {
    activeView = event.detail;
    
    // Handle special views
    if (activeView === 'dashboard' && !$tabs.find(t => t.type === 'dashboard')) {
      createDashboardTab();
    } else if (activeView === 'settings') {
      showSettingsModal = true;
    }
  }
  
  async function openTerminal() {
    if (isTauri) {
      await createTauriTerminal('Terminal');
    } else {
      await createTerminal('Terminal');
    }
  }
  
  function toggleSidebar() {
    sidebarVisible = !sidebarVisible;
  }
  
  async function saveCurrentFile() {
    if ($activeTab?.type === 'file' && isTauri) {
      // Trigger save in Neovim
      const { invoke } = await import('@tauri-apps/api/core');
      invoke('nvim_execute_command', {
        instanceId: $activeTab.metadata?.instanceId,
        command: ':w'
      });
    }
  }
  
  function closeCurrentTab() {
    if ($activeTab) {
      tabs.update(t => t.filter(tab => tab.id !== $activeTab.id));
    }
  }
  
  function handleSplitView(direction: 'horizontal' | 'vertical') {
    if (direction === 'horizontal') {
      layoutMode = layoutMode === 'split-horizontal' ? 'single' : 'split-horizontal';
    } else {
      layoutMode = layoutMode === 'split-vertical' ? 'single' : 'split-vertical';
    }
    
    if (layoutMode !== 'single' && $tabs.length > 1) {
      secondaryTab = $tabs.find(t => t.id !== $activeTab?.id) || null;
    } else {
      secondaryTab = null;
    }
  }
  
  function renderTabContent(tab: Tab | null, isPrimary = true) {
    if (!tab) return null;
    
    const components = {
      terminal: isTauri ? TauriTerminal : Terminal,
      dashboard: DashboardEnhanced,
      file: NeovimEditor,
      test: TestResultsView,
      settings: ConfigPanel,
    };
    
    return components[tab.type] || null;
  }
  
  async function handleCommand(event: CustomEvent<{ action: string }>) {
    const action = event.detail.action;
    
    switch (action) {
      // File actions
      case 'newFile':
      case 'openFile':
      case 'save':
        saveCurrentFile();
        break;
      case 'closeTab':
        closeCurrentTab();
        break;
      case 'closeAllTabs':
        tabs.set([]);
        break;
        
      // View actions
      case 'showExplorer':
        activeView = 'explorer';
        break;
      case 'showSearch':
        activeView = 'search';
        break;
      case 'showGit':
        activeView = 'git';
        showGitPanel = true;
        break;
      case 'showExtensions':
        activeView = 'extensions';
        break;
      case 'showDashboard':
        activeView = 'dashboard';
        handleViewChange({ detail: 'dashboard' });
        break;
      case 'toggleSidebar':
        toggleSidebar();
        break;
        
      // Terminal actions
      case 'newTerminal':
        openTerminal();
        break;
        
      // Window actions
      case 'splitHorizontal':
        handleSplitView('horizontal');
        break;
      case 'splitVertical':
        handleSplitView('vertical');
        break;
      case 'toggleFullscreen': {
        if (isTauri) {
          const { appWindow } = await import('@tauri-apps/api/window');
          const isFullscreen = await appWindow.isFullscreen();
          await appWindow.setFullscreen(!isFullscreen);
        }
        break;
      }
        
      // Settings actions
      case 'openSettings':
        showSettings = true;
        break;
      case 'toggleTheme':
        toggleTheme();
        break;
        
      // Navigation
      case 'nextTab': {
        const currentIndex = $tabs.findIndex(t => t.id === $activeTab?.id);
        if (currentIndex < $tabs.length - 1) {
          activeTab.set($tabs[currentIndex + 1]);
        }
        break;
      }
      case 'prevTab': {
        const currentIdx = $tabs.findIndex(t => t.id === $activeTab?.id);
        if (currentIdx > 0) {
          activeTab.set($tabs[currentIdx - 1]);
        }
        break;
      }
        
      // Misc actions
      case 'reload':
        location.reload();
        break;
      case 'shareWorkflow':
        showShareDialog = true;
        break;
        
      // AI actions
      case 'aiAssist':
        // TODO: Implement AI assistant
        console.log('AI assist requested');
        break;
        
      default:
        console.log('Unhandled command:', action);
    }
  }
</script>

<svelte:head>
  <title>OrchFlow</title>
</svelte:head>

<!-- Update Notification -->
<UpdateNotification />

<!-- Share Dialog -->
<ShareDialog bind:show={showShareDialog} />

<!-- Main Application -->
<div class="app" class:sidebar-hidden={!sidebarVisible}>
  <!-- Activity Bar -->
  <ActivityBar {activeView} on:viewChange={handleViewChange} />
  
  <!-- Sidebar -->
  {#if sidebarVisible}
    <Sidebar 
      {activeView} 
      {sessionId}
      on:openFile={(e) => openFile(e.detail)}
      on:share={() => showShareDialog = true}
    />
  {/if}
  
  <!-- Main Content -->
  <div class="main-content">
    <!-- Tab Bar -->
    <div class="tab-bar-container">
      <TabBar />
      <div class="tab-actions">
        <button 
          class="split-button"
          class:active={layoutMode === 'split-horizontal'}
          on:click={() => handleSplitView('horizontal')}
          title="Split Horizontal"
        >
          ⬌
        </button>
        <button 
          class="split-button"
          class:active={layoutMode === 'split-vertical'}
          on:click={() => handleSplitView('vertical')}
          title="Split Vertical"
        >
          ⬍
        </button>
      </div>
    </div>
    
    <!-- Editor Area -->
    <div class="editor-area" class:split-horizontal={layoutMode === 'split-horizontal'} class:split-vertical={layoutMode === 'split-vertical'}>
      <!-- Primary Pane -->
      <div class="editor-pane primary">
        {#if $activeTab}
          {#if $activeTab.type === 'terminal'}
            <TauriTerminal 
              paneId={$activeTab.metadata?.paneId}
              command={$activeTab.metadata?.command}
              title={$activeTab.title}
            />
          {:else if $activeTab.type === 'dashboard'}
            <DashboardEnhanced />
          {:else if $activeTab.type === 'file'}
            <NeovimEditor 
              filePath={$activeTab.metadata?.filePath}
              title={$activeTab.title}
              instanceId={$activeTab.metadata?.instanceId}
            />
          {:else if $activeTab.type === 'test'}
            <TestResultsView {sessionId} />
          {:else if $activeTab.type === 'settings'}
            <ConfigPanel
              title="Settings"
              config={$settings}
              show={true}
              on:save={(e) => settings.update(() => e.detail)}
              on:close={() => closeCurrentTab()}
            />
          {/if}
        {:else}
          <div class="welcome">
            <div class="logo">🌊</div>
            <h1>Welcome to OrchFlow</h1>
            <p>The terminal-first IDE with AI orchestration</p>
            
            <div class="quick-actions">
              <button class="quick-action" on:click={openTerminal}>
                <span class="icon">📟</span>
                <span class="label">Open Terminal</span>
                <span class="shortcut">Ctrl+`</span>
              </button>
              
              <button class="quick-action" on:click={() => showCommandPalette = true}>
                <span class="icon">🔍</span>
                <span class="label">Command Palette</span>
                <span class="shortcut">Ctrl+P</span>
              </button>
              
              <button class="quick-action" on:click={() => activeView = 'explorer'}>
                <span class="icon">📁</span>
                <span class="label">File Explorer</span>
                <span class="shortcut">Ctrl+Shift+E</span>
              </button>
              
              <button class="quick-action" on:click={() => showSettingsModal = true}>
                <span class="icon">⚙️</span>
                <span class="label">Settings</span>
                <span class="shortcut">Ctrl+,</span>
              </button>
            </div>
            
            <div class="recent-files">
              <h3>Recent Files</h3>
              <p class="empty">No recent files</p>
            </div>
          </div>
        {/if}
      </div>
      
      <!-- Secondary Pane (when split) -->
      {#if layoutMode !== 'single' && secondaryTab}
        <div class="editor-pane secondary">
          {#if secondaryTab.type === 'terminal'}
            <TauriTerminal 
              paneId={secondaryTab.metadata?.paneId}
              command={secondaryTab.metadata?.command}
              title={secondaryTab.title}
            />
          {:else if secondaryTab.type === 'file'}
            <NeovimEditor 
              filePath={secondaryTab.metadata?.filePath}
              title={secondaryTab.title}
              instanceId={secondaryTab.metadata?.instanceId}
            />
          {:else if secondaryTab.type === 'dashboard'}
            <DashboardEnhanced />
          {:else if secondaryTab.type === 'test'}
            <TestResultsView {sessionId} />
          {/if}
        </div>
      {/if}
    </div>
    
    <!-- Status Bar -->
    <StatusBar {sessionId} />
  </div>
  
  <!-- Settings Modal -->
  <SettingsModal
    isOpen={showSettingsModal}
    onClose={() => showSettingsModal = false}
  />
  
  <!-- Command Palette -->
  <CommandPalette 
    bind:show={showCommandPalette}
    on:command={handleCommand}
  />
  
  <!-- Git Panel -->
  <GitPanel
    bind:show={showGitPanel}
    {sessionId}
  />
  
  <!-- Symbol Outline -->
  <SymbolOutline
    isOpen={showSymbolOutline}
    onClose={() => showSymbolOutline = false}
  />
</div>

<style>
  :global(:root) {
    /* Layout dimensions */
    --activity-bar-width: 48px;
    --sidebar-width: 260px;
    --tab-bar-height: 35px;
    --status-bar-height: 22px;
  }
  
  :global(body) {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    font-size: 13px;
    color: var(--fg-primary);
    background: var(--bg-primary);
  }
  
  .app {
    display: flex;
    height: 100vh;
    width: 100vw;
    overflow: hidden;
  }
  
  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .tab-bar-container {
    display: flex;
    align-items: center;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
  }
  
  .tab-actions {
    display: flex;
    gap: 4px;
    padding: 0 8px;
  }
  
  .split-button {
    background: none;
    border: none;
    color: var(--fg-tertiary);
    padding: 4px 8px;
    cursor: pointer;
    border-radius: 3px;
    font-size: 16px;
    transition: all 0.2s;
  }
  
  .split-button:hover {
    background: var(--bg-hover);
    color: var(--fg-primary);
  }
  
  .split-button.active {
    background: var(--bg-tertiary);
    color: var(--accent);
  }
  
  .editor-area {
    flex: 1;
    display: flex;
    background: var(--bg-primary);
    overflow: hidden;
  }
  
  .editor-area.split-horizontal {
    flex-direction: row;
  }
  
  .editor-area.split-vertical {
    flex-direction: column;
  }
  
  .editor-pane {
    flex: 1;
    overflow: hidden;
    position: relative;
  }
  
  .editor-pane.secondary {
    border-left: 1px solid var(--border);
  }
  
  .editor-area.split-vertical .editor-pane.secondary {
    border-left: none;
    border-top: 1px solid var(--border);
  }
  
  /* Welcome Screen */
  .welcome {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    max-width: 600px;
    margin: 0 auto;
  }
  
  .logo {
    font-size: 64px;
    margin-bottom: 24px;
  }
  
  .welcome h1 {
    font-size: 32px;
    font-weight: 300;
    margin: 0 0 8px 0;
    color: var(--fg-primary);
  }
  
  .welcome p {
    font-size: 16px;
    color: var(--fg-secondary);
    margin: 0 0 40px 0;
  }
  
  .quick-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    width: 100%;
    margin-bottom: 40px;
  }
  
  .quick-action {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
  }
  
  .quick-action:hover {
    background: var(--bg-tertiary);
    border-color: var(--accent);
  }
  
  .quick-action .icon {
    font-size: 24px;
  }
  
  .quick-action .label {
    flex: 1;
    font-size: 14px;
    color: var(--fg-primary);
  }
  
  .quick-action .shortcut {
    font-size: 11px;
    color: var(--fg-tertiary);
    background: var(--bg-tertiary);
    padding: 2px 6px;
    border-radius: 3px;
  }
  
  .recent-files {
    width: 100%;
  }
  
  .recent-files h3 {
    font-size: 14px;
    font-weight: 500;
    margin: 0 0 12px 0;
    color: var(--fg-secondary);
  }
  
  .recent-files .empty {
    text-align: center;
    color: var(--fg-tertiary);
    padding: 20px;
  }
  
  
  
  /* Responsive */
  .app.sidebar-hidden .main-content {
    margin-left: 0;
  }
</style>